name: iris-sec CI Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: 3.10
          environment-file: environment.yml
          auto-activate-base: false
          activate-environment: iris
          use-only-tar-bz2: true
          auto-update-conda: true
          
      - name: Set up Java 8 and Maven
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'
          cache: 'maven'
          maven-version: '3.5.0'

      - name: Download CodeQL Bundle
        run: curl -L https://github.com/github/codeql-action/releases/download/codeql-bundle-v2.15.0/codeql-bundle-linux64.tar.gz -o codeql-bundle.tar.gz

      - name: Extract CodeQL Bundle
        run: tar -xzf codeql-bundle.tar.gz

      - name: Export to PATH
        run: export PATH="$PWD/codeql:$PATH"

      - name: Update CodeQL Query version in config
        run: sed -i "s/^CODEQL_QUERY_VERSION = \".*\"$/CODEQL_QUERY_VERSION = \"0.8.0"/" src/config.py

      - name: Build perwendel-spark
        run: python scripts/setup.py --filter perwendel__spark_CVE-2018-9159_2.7.1

      - name: Generate CodeQL database
        run: python scripts/build_codeql_dbs.py --project perwendel__spark_CVE-2018-9159_2.7.1

      - name: Run IRIS
        run: python src/neusym_vul.py --query cwe-022wLLM --run-id test --llm qwen2.5-coder-7b perwendel__spark_CVE-2018-9159_2.7.1


        
